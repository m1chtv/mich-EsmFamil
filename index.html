<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø§Ø³Ù…â€ŒÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ† | Real-Time</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
      body {
        background: radial-gradient(circle at top, #1e293b, #020617);
        color: #fff;
        min-height: 100vh;
      }
      .glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 18px;
      }
      input {
        background: rgba(2, 6, 23, 0.7) !important;
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }
      input:focus {
        box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25) !important;
      }
      input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .letter {
        font-size: 4rem;
        font-weight: 900;
        color: #fbbf24;
        text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
      }
      .timer {
        font-size: 2.4rem;
        font-weight: 800;
        color: #ef4444;
      }
      .players {
        position: fixed;
        left: 20px;
        top: 20px;
        width: 190px;
        animation: fadeIn 0.5s ease;
      }
      .players li {
        list-style: none;
        padding: 8px 12px;
        margin: 4px 0;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
      }
      .players li:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(-5px);
      }
      .players li.you {
        background: rgba(59, 130, 246, 0.2);
        border-left: 3px solid #3b82f6;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
        }
      }
      .btn-warning {
        background-color: #f59e0b;
        border-color: #f59e0b;
      }
      .btn-warning:hover {
        background-color: #d97706;
        border-color: #d97706;
      }
      .btn-danger {
        background-color: #ef4444;
        border-color: #ef4444;
      }
      .btn-danger:hover {
        background-color: #dc2626;
        border-color: #dc2626;
      }
      #game {
        max-width: 800px;
        margin: 0 auto;
      }
      .category {
        margin-bottom: 10px;
      }
      .category-label {
        font-size: 0.9rem;
        color: #94a3b8;
        margin-bottom: 4px;
        padding-right: 8px;
      }
      @media (max-width: 768px) {
        .players {
          position: static;
          width: 100%;
          margin-bottom: 20px;
        }
        .letter {
          font-size: 3rem;
        }
        .timer {
          font-size: 2rem;
        }
      }
      .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
      }
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #connectionStatus {
        position: fixed;
        bottom: 10px;
        left: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
      }
      .connection-online {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid #22c55e;
      }
      .connection-offline {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
      }
    </style>
  </head>

  <body class="container py-4">
    <div id="connectionStatus" class="connection-offline d-none">
      <i class="bi bi-wifi-off"></i> Ø¢ÙÙ„Ø§ÛŒÙ†
    </div>

    <div id="loading" class="d-none">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3"></div>
        <div>Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
      </div>
    </div>

    <div id="errorAlert" class="alert alert-danger d-none"></div>

    <h2 class="text-center mb-4">ğŸ® Ø§Ø³Ù…â€ŒÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>

    <div id="login" class="glass p-4 mx-auto" style="max-width: 400px">
      <h4 class="text-center mb-3">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</h4>
      <input id="username" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø´Ù…Ø§" />
      <div class="d-grid gap-2">
        <button class="btn btn-primary" onclick="createRoom()">
          <i class="bi bi-plus-circle"></i> Ø³Ø§Ø®Øª Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
        </button>
        <div class="text-center my-2">ÛŒØ§</div>
        <button class="btn btn-success" onclick="joinRoom()">
          <i class="bi bi-arrow-right-circle"></i> Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ
        </button>
      </div>
      <div class="mt-3 text-center">
        <small class="text-muted">Ù†Ø³Ø®Ù‡ Ø¨Ø¯ÙˆÙ† Ø§ÛŒÙ†ØªØ±Ù†Øª (Ø¢ÙÙ„Ø§ÛŒÙ†)</small>
        <button
          class="btn btn-outline-light btn-sm w-100 mt-2"
          onclick="startOfflineGame()"
        >
          <i class="bi bi-play-circle"></i> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
        </button>
      </div>
    </div>

    <div id="game" class="d-none">
      <div class="players glass p-3">
        <h6 class="text-center mb-3"><i class="bi bi-people"></i> Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h6>
        <ul id="playerList" class="p-0 m-0"></ul>
      </div>

      <div class="glass p-3 mb-4 text-center">
        <div class="input-group">
          <input id="invite" class="form-control" readonly />
          <button class="btn btn-outline-light" onclick="copyInviteLink()">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>
        <small class="text-muted mt-2 d-block" id="inviteHelp"
          >Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Øª Ø¨ÙØ±Ø³Øª ØªØ§ Ø¨ØªÙˆÙ†Ù† Ø¨ÛŒØ§Ù† ØªÙˆ Ø¨Ø§Ø²ÛŒ</small
        >
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6 glass p-4 text-center">
          <div class="mb-3">Ø­Ø±Ù Ø¨Ø§Ø²ÛŒ:</div>
          <div class="letter" id="letter">ØŸ</div>
          <button
            id="startBtn"
            class="btn btn-warning mt-3"
            onclick="startGame()"
          >
            <i class="bi bi-play-fill"></i> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
          </button>
        </div>

        <div class="col-md-6 glass p-4 text-center">
          <div class="mb-3">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:</div>
          <div class="timer" id="timer">60</div>
          <button class="btn btn-danger mt-3" onclick="stopGame()">
            <i class="bi bi-stop-fill"></i> Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
          </button>
        </div>
      </div>

      <div class="glass p-4">
        <h5 class="text-center mb-4">Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h5>
        <div class="row g-3">
          <div class="col-md-6 category">
            <div class="category-label">Ø§Ø³Ù…</div>
            <input id="name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ" />
          </div>
          <div class="col-md-6 category">
            <div class="category-label">ÙØ§Ù…ÛŒÙ„</div>
            <input id="family" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø­Ù…Ø¯ÛŒ" />
          </div>
          <div class="col-md-6 category">
            <div class="category-label">Ø´Ù‡Ø±</div>
            <input id="city" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØªÙ‡Ø±Ø§Ù†" />
          </div>
          <div class="col-md-6 category">
            <div class="category-label">Ú©Ø´ÙˆØ±</div>
            <input
              id="country"
              class="form-control"
              placeholder="Ù…Ø«Ø§Ù„: Ø§ÛŒØ±Ø§Ù†"
            />
          </div>
          <div class="col-md-6 category">
            <div class="category-label">Ù…ÛŒÙˆÙ‡</div>
            <input id="fruit" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø³ÛŒØ¨" />
          </div>
          <div class="col-md-6 category">
            <div class="category-label">Ø§Ø´ÛŒØ§</div>
            <input id="object" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØµÙ†Ø¯Ù„ÛŒ" />
          </div>
        </div>
        <div class="mt-4 text-center">
          <small class="text-muted"
            >ØªÙˆØ¬Ù‡: Ù‡Ù…Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø­Ø±Ù Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Ø´ÙˆÙ†Ø¯</small
          >
        </div>
      </div>

      <div id="results" class="glass p-4 mt-4 d-none">
        <h4 class="text-center mb-4">Ù†ØªØ§ÛŒØ¬ Ø¨Ø§Ø²ÛŒ</h4>
        <div id="resultsContent"></div>
      </div>
    </div>

    <script>
      const letters = "Ø§Ø¨Ù¾ØªØ«Ø¬Ú†Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚Ú©Ú¯Ù„Ù…Ù†ÙˆÙ‡ÛŒ".split("");
      const q = new URLSearchParams(location.search);
      let room = q.get("room");
      let user = "";
      let userId = "";
      let isHost = false;
      let isOnline = false;
      let timerInterval = null;

      const SUPABASE_URL = "https://jpezvnqzecbuzsxrendd.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_LZ_UulW82sSCkzhztT3X8A_KEPanRtA";
      let supabase = null;
      let supabaseChannel = null;

      function initializeSupabase() {
        try {
          if (typeof window.supabase === "undefined") {
            throw new Error("Supabase not loaded");
          }

          supabaseClient = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY,
          );
          isOnline = true;
          updateConnectionStatus(true);
          console.log("Supabase connected successfully");
          return true;
        } catch (error) {
          console.error("Failed to initialize Supabase:", error);
          updateConnectionStatus(false);
          return false;
        }
      }

      function updateConnectionStatus(connected) {
        isOnline = connected;
        const statusElement = document.getElementById("connectionStatus");

        if (connected) {
          statusElement.className = "connection-online";
          statusElement.innerHTML = '<i class="bi bi-wifi"></i> Ø¢Ù†Ù„Ø§ÛŒÙ†';
        } else {
          statusElement.className = "connection-offline";
          statusElement.innerHTML = '<i class="bi bi-wifi-off"></i> Ø¢ÙÙ„Ø§ÛŒÙ†';
        }
        statusElement.classList.remove("d-none");
      }

      function startOfflineGame() {
        user = document.getElementById("username").value.trim();
        if (!user) {
          alert("Ù„Ø·ÙØ§ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
          return;
        }

        userId = "offline_" + Date.now();
        room =
          "OFFLINE_" + Math.random().toString(36).slice(2, 7).toUpperCase();

        document.getElementById("login").remove();
        document.getElementById("game").classList.remove("d-none");

        document.getElementById("invite").value =
          "Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù†ÙØ±";
        document.getElementById("inviteHelp").textContent =
          "Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø³Øª Ùˆ Ø¨Ù‚ÛŒÙ‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ù†Ø¯";

        setupOfflineGame();
      }

      function setupOfflineGame() {
        isHost = true;

        const playerList = document.getElementById("playerList");
        playerList.innerHTML = "";

        const li = document.createElement("li");
        li.className = "you";
        li.innerHTML = `<i class="bi bi-person-fill"></i> ${user} <small>(Ø´Ù…Ø§ - Ø¢ÙÙ„Ø§ÛŒÙ†)</small>`;
        playerList.appendChild(li);

        document.getElementById("startBtn").disabled = false;
      }

      function createRoom() {
        user = document.getElementById("username").value.trim();
        if (!user) {
          alert("Ù„Ø·ÙØ§ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
          return;
        }

        document.getElementById("loading").classList.remove("d-none");

        if (!initializeSupabase()) {
          startOfflineGame();
          return;
        }

        userId = "user_" + Math.random().toString(36).slice(2, 9);
        room = Math.random().toString(36).slice(2, 7).toUpperCase();

        supabaseClient
          .from("rooms")
          .insert({
            room_code: room,
            host_id: userId,
            host_name: user,
            letter: "",
            timer: 60,
            game_started: false,
            game_over: false,
            created_at: new Date().toISOString(),
          })
          .then(({ data, error }) => {
            if (error) throw error;
            location.href = `?room=${room}&user=${encodeURIComponent(user)}&uid=${userId}`;
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("d-none");
            console.error("Error creating room:", error);

            if (
              confirm(
                "Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ØŸ",
              )
            ) {
              startOfflineGame();
            }
          });
      }

      function joinRoom() {
        user = document.getElementById("username").value.trim();
        if (!user) {
          alert("Ù„Ø·ÙØ§ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
          return;
        }

        const roomCode = prompt("Ú©Ø¯ Ø§ØªØ§Ù‚ Ø¨Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
        if (!roomCode) return;

        document.getElementById("loading").classList.remove("d-none");

        if (!initializeSupabase()) {
          alert(
            "Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª. Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯.",
          );
          document.getElementById("loading").classList.add("d-none");
          return;
        }

        userId = "user_" + Math.random().toString(36).slice(2, 9);

        supabaseClient
          .from("rooms")
          .select("*")
          .eq("room_code", roomCode.toUpperCase())
          .single()
          .then(({ data, error }) => {
            if (error) throw new Error("Ø§ÛŒÙ† Ø§ØªØ§Ù‚ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯");
            location.href = `?room=${roomCode.toUpperCase()}&user=${encodeURIComponent(user)}&uid=${userId}`;
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("d-none");
            showError(error.message);
          });
      }

      function initGame() {
        if (!room) return;

        user = decodeURIComponent(q.get("user") || "Ø¨Ø§Ø²ÛŒÚ©Ù†");
        userId =
          q.get("uid") || "user_" + Math.random().toString(36).slice(2, 9);

        if (room.startsWith("OFFLINE_")) {
          setupOfflineGame();
          document.getElementById("loading").classList.add("d-none");
          return;
        }

        if (!initializeSupabase()) {
          showError(
            "Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.",
          );
          setTimeout(() => {
            location.href = window.location.pathname;
          }, 3000);
          return;
        }

        document.getElementById("login").remove();
        document.getElementById("game").classList.remove("d-none");
        document.getElementById("loading").classList.add("d-none");

        const inviteLink = `${window.location.origin}${window.location.pathname}?room=${room}`;
        document.getElementById("invite").value = inviteLink;

        supabaseClient
          .from("rooms")
          .select("*")
          .eq("room_code", room)
          .single()
          .then(({ data: roomData, error }) => {
            if (error) {
              showError("Ø§ÛŒÙ† Ø§ØªØ§Ù‚ Ø¨Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!");
              setTimeout(() => {
                location.href = window.location.pathname;
              }, 3000);
              return;
            }

            isHost = roomData.host_id === userId;

            const startBtn = document.getElementById("startBtn");
            if (!isHost) {
              startBtn.disabled = true;
              startBtn.innerHTML =
                '<i class="bi bi-clock"></i> Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ù…ÛŒØ²Ø¨Ø§Ù†';
            }

            supabaseClient
              .from("players")
              .upsert({
                room_code: room,
                player_id: userId,
                player_name: user,
                joined_at: new Date().toISOString(),
                score: 0,
                answers: {
                  name: "",
                  family: "",
                  city: "",
                  country: "",
                  fruit: "",
                  object: "",
                },
              })
              .then(() => {
                setupSupabaseListeners();
              });
          })
          .catch((error) => {
            showError("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ØªØ§Ù‚: " + error.message);
            document.getElementById("loading").classList.add("d-none");
          });
      }

      function setupSupabaseListeners() {
        if (!supabaseClient) {
          console.log("Using localStorage fallback");
          setupLocalStorageListeners();
          return;
        }

        // Real-time Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
        supabaseChannel = supabaseClient
          .channel("room-" + room)
          .on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: "players",
              filter: `room_code=eq.${room}`,
            },
            (payload) => {
              if (
                payload.eventType === "INSERT" ||
                payload.eventType === "UPDATE"
              ) {
                updatePlayerList(payload.new);
              }
              if (payload.eventType === "DELETE") {
                removePlayer(payload.old.player_id);
              }
            },
          )
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "rooms",
              filter: `room_code=eq.${room}`,
            },
            (payload) => {
              const roomData = payload.new;
              document.getElementById("letter").textContent =
                roomData.letter || "ØŸ";
              document.getElementById("timer").textContent = roomData.timer;

              if (roomData.letter) {
                enableInputs();
              }

              if (roomData.timer === 0 || roomData.game_over) {
                lockInputs();
                if (isHost) {
                  calculateResults();
                }
              }
            },
          )
          .subscribe();
      }

      function updatePlayerList(player) {
        const liId = "p-" + player.player_id;
        let li = document.getElementById(liId);

        if (!li) {
          li = document.createElement("li");
          li.id = liId;
          li.innerHTML = `<i class="bi bi-person-fill"></i> ${player.player_name}`;

          if (player.player_id === userId) {
            li.classList.add("you");
            li.innerHTML += " <small>(Ø´Ù…Ø§)</small>";
          }

          document.getElementById("playerList").appendChild(li);
        }
      }

      function removePlayer(playerId) {
        const el = document.getElementById("p-" + playerId);
        if (el) el.remove();
      }

      function setupLocalStorageListeners() {
        window.addEventListener("storage", (e) => {
          if (e.key === `esmfamil_${room}`) {
            const data = JSON.parse(e.newValue);
            if (data.type === "letter") {
              document.getElementById("letter").textContent = data.value;
              enableInputs();
            }
            if (data.type === "timer") {
              document.getElementById("timer").textContent = data.value;
            }
          }
        });
      }

      function startGame() {
        const randomLetter =
          letters[Math.floor(Math.random() * letters.length)];

        if (isOnline && supabaseClient) {
          supabaseClient
            .from("rooms")
            .update({
              letter: randomLetter,
              game_started: true,
              game_over: false,
              timer: 60,
            })
            .eq("room_code", room);
        } else {
          document.getElementById("letter").textContent = randomLetter;
          enableInputs();
        }

        if (timerInterval) clearInterval(timerInterval);

        let timeLeft = 60;
        timerInterval = setInterval(() => {
          timeLeft--;

          if (isOnline && supabaseClient) {
            supabaseClient
              .from("rooms")
              .update({ timer: timeLeft })
              .eq("room_code", room);
          } else {
            document.getElementById("timer").textContent = timeLeft;
          }

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            if (isOnline && supabaseClient) {
              supabaseClient
                .from("rooms")
                .update({ game_over: true })
                .eq("room_code", room);
            } else {
              lockInputs();
              calculateOfflineResults();
            }
          }
        }, 1000);
      }

      function stopGame() {
        const answers = getAnswers();

        const filledCount = Object.values(answers).filter(
          (v) => v.trim() !== "",
        ).length;
        if (filledCount < 3) {
          alert("Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ù…ÙˆØ±Ø¯ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");
          return;
        }

        const currentLetter = document.getElementById("letter").textContent;
        if (currentLetter !== "ØŸ") {
          for (const [category, answer] of Object.entries(answers)) {
            if (answer.trim() && !answer.trim().startsWith(currentLetter)) {
              alert(
                `Ù¾Ø§Ø³Ø® "${answer}" Ø¨Ø±Ø§ÛŒ "${category}" Ø¨Ø§ Ø­Ø±Ù "${currentLetter}" Ø´Ø±ÙˆØ¹ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯`,
              );
              return;
            }
          }
        }

        if (isOnline && supabaseClient) {
          supabaseClient
            .from("players")
            .update({ answers: answers })
            .eq("room_code", room)
            .eq("player_id", userId);

          if (isHost) {
            supabaseClient
              .from("rooms")
              .update({ timer: 0, game_over: true })
              .eq("room_code", room);
          }
        } else {
          if (timerInterval) clearInterval(timerInterval);
          document.getElementById("timer").textContent = 0;
          lockInputs();
          calculateOfflineResults();
        }
      }

      function getAnswers() {
        return {
          name: document.getElementById("name").value.trim(),
          family: document.getElementById("family").value.trim(),
          city: document.getElementById("city").value.trim(),
          country: document.getElementById("country").value.trim(),
          fruit: document.getElementById("fruit").value.trim(),
          object: document.getElementById("object").value.trim(),
        };
      }

      function lockInputs() {
        document.querySelectorAll("#game input").forEach((input) => {
          input.disabled = true;
        });
      }

      function enableInputs() {
        document
          .querySelectorAll("#game input:not(#invite)")
          .forEach((input) => {
            input.disabled = false;
          });
      }

      function calculateResults() {
        if (!isOnline || !supabaseClient) return;

        supabaseClient
          .from("players")
          .select("*")
          .eq("room_code", room)
          .then(({ data: players, error }) => {
            if (error || !players) return;

            const currentLetter = document.getElementById("letter").textContent;
            const results = [];

            players.forEach((player) => {
              if (player.answers) {
                results.push({
                  name: player.player_name,
                  answers: player.answers,
                  score: 0,
                });
              }
            });

            calculateAndDisplayResults(results);
          });
      }

      function calculateOfflineResults() {
        const answers = getAnswers();
        const results = [
          {
            name: user,
            answers: answers,
            score: 100,
          },
        ];

        calculateAndDisplayResults(results);
      }

      function calculateAndDisplayResults(results) {
        const currentLetter = document.getElementById("letter").textContent;
        const categories = [
          "name",
          "family",
          "city",
          "country",
          "fruit",
          "object",
        ];

        categories.forEach((category) => {
          const answers = results.map(
            (r) => r.answers[category]?.trim().toLowerCase() || "",
          );
          const uniqueAnswers = {};

          answers.forEach((answer) => {
            if (answer) {
              uniqueAnswers[answer] = (uniqueAnswers[answer] || 0) + 1;
            }
          });

          results.forEach((result, index) => {
            const answer = answers[index];
            if (answer) {
              if (uniqueAnswers[answer] === 1) {
                result.score += 20;
              } else if (uniqueAnswers[answer] === 2) {
                result.score += 10;
              } else {
                result.score += 5;
              }
            }
          });
        });

        results.sort((a, b) => b.score - a.score);

        displayResults(results);
      }

      function displayResults(results) {
        const resultsDiv = document.getElementById("results");
        const contentDiv = document.getElementById("resultsContent");

        resultsDiv.classList.remove("d-none");

        let html =
          '<div class="table-responsive"><table class="table table-dark table-hover">';
        html +=
          "<thead><tr><th>Ø±ØªØ¨Ù‡</th><th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th><th>Ø§Ù…ØªÛŒØ§Ø²</th></tr></thead><tbody>";

        results.forEach((result, index) => {
          html += `<tr>
                    <td>${index + 1}</td>
                    <td>${result.name} ${result.name === user ? "(Ø´Ù…Ø§)" : ""}</td>
                    <td>${result.score}</td>
                </tr>`;
        });

        html += "</tbody></table></div>";
        contentDiv.innerHTML = html;
      }

      function copyInviteLink() {
        const inviteInput = document.getElementById("invite");
        inviteInput.select();
        inviteInput.setSelectionRange(0, 99999);

        try {
          navigator.clipboard.writeText(inviteInput.value);
          alert("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!");
        } catch (err) {
          document.execCommand("copy");
          alert("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!");
        }
      }

      function showError(message) {
        const errorAlert = document.getElementById("errorAlert");
        errorAlert.textContent = message;
        errorAlert.classList.remove("d-none");
        setTimeout(() => {
          errorAlert.classList.add("d-none");
        }, 5000);
      }

      function showWarning(message) {
        const errorAlert = document.getElementById("errorAlert");
        errorAlert.textContent = message;
        errorAlert.className = "alert alert-warning";
        errorAlert.classList.remove("d-none");
        setTimeout(() => {
          errorAlert.classList.add("d-none");
          errorAlert.className = "alert alert-danger";
        }, 3000);
      }

      window.addEventListener("beforeunload", () => {
        if (supabaseClient && room && userId) {
          supabaseClient
            .from("players")
            .delete()
            .eq("room_code", room)
            .eq("player_id", userId);
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        if (room) {
          document.getElementById("loading").classList.remove("d-none");
          initGame();
        }
      });
    </script>
  </body>
</html>
